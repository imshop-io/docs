# Расчет корзины, скидок, баллов

{% hint style="info" %}
Для подключения webhook расчета корзины, обратитесь к вашему менеджеру в IMSHOP.IO
{% endhint %}

IMSHOP.IO позволяет при помощи webhook подключить уже существующую на вашей стороне систему пересчета корзины с учетом акций, предложений, бонусных баллов итд.

{% hint style="info" %}
Пересчет корзины через webhook означает, что для каждого изменения состава корзины IMSHOP.IO будет отправлять данные о заказе в систему клиента и ожидать в ответ данные об итоговой стоимости заказа и примененных маркетинговых акциях
{% endhint %}

## Формат запроса и примеры

### Пример запроса

```javascript
{
    "city": "Москва",
    "cityKladr": "7700000000000",
    "fiasCode": "77000000000000000000000",
    "deliveryId": null,
    "paymentId": null,
    "items": [
        {
          "name": "Тестовый товар 1",
          "id": "00a03026-412a-54fe-a9df-dcf9325f8618",
          "privateId": "3464",
          "configurationId": "3464",
          "price": 3735,
          "quantity": 1,
          "subtotal": 3735
        },
        {
          "name": "Тестовый товар 2",
          "id": "605e0108-dc95-5dab-95a2-7f459da6aade",
          "privateId": "29117",
          "configurationId": "29117",
          "price": 14540,
          "quantity": 1,
          "subtotal": 14540
        },
        {
          "name": "Тестовый товар 3",
          "id": "3ccd380e-1f40-5056-8a7a-ef6e8a9582b5",
          "privateId": "34607",
          "configurationId": "34607",
          "price": 5723,
          "quantity": 2,
          "subtotal": 11446
        },
        {
          "name": "Тестовый товар 4",
          "id": "523036eb-b776-5795-b24b-0f224f2d8b17",
          "privateId": "6527",
          "configurationId": "6527",
          "price": 29336,
          "quantity": 1,
          "subtotal": 29336
        },
        {
          "name": "Кабель питания Baseus",
          "id": "02ebe9c7-20f0-4cf0-8160-396ef2604daa",
          "privateId": "1234567800",
          "configurationId": "1234567800",
          "price": 2000,
          "quantity": 2,
          "appliedDiscounts": ["dd771099"]
        }
    ],
    "externalUserId": "XXXXXXX",
    "promocode": "12345",
    "loyaltyCard": "12345"
}
```

### Описание формата запроса

* **`city`** - Стандартизированное название города из системы ФИАС
* **`cityKladr`** - КЛАДР города
* **`fiasCode`** - ФИАС код
* **`deliveryId`** - идентификатор выбранной службы доставки в IMSHOP.IO \(**`null`** если доставка еще не выбрана\)
* **`paymentId`** - идентификатор выбранной службы оплаты в IMSHOP.IO \(**`null`** если оплата еще не выбрана\)
* **`items`** - состав корзины
  * **`name`** - наименование
  * **`id`** - идентификатор товара в IMSHOP.IO
  * **`privateId`** - идентификатор товарного предложения в системе клиента
  * **`configurationId`** - идентификатор товарного предложения в IMSHOP.IO
  * **`price`** - цена товара на момент добавления в корзину \(если товар - это подарок на выбор, то тут передается `0`\)
  * **`quantity`** - количество
  * **`subtotal`** - итого по позиции \(`subtotal` = `price` \* `quantity`\)
  * **`appliedDiscounts`** - если предыдущий расчет показал наличие маркетинговой акции, или это - подарок на выбор, то передаем идентификатор акции из прошлого ответа от API.
* **`externalUserId`** - идентификатор покупателя в системе клиента, если известен
* **`promocode`** - промокод, введенный покупателем
* **`loyaltyCart`** - номер карты лояльности \(обычно карта лояльности передаваться не будет, так как она часто уже прикреплена к аккаунту покупателя. используется для анонимных заказов, или если клиент не имеет привязки карт лояльности к профилям пользователей\)

## Формат ответа и примеры

### Описание формата

Бекенд клиента должен ответить на вебхук с `application/json` в следующем формате:

* **`totalPrice`** - итоговая цена корзины с учетом всех скидок и МА
* **`appliedPromocode`** - примененный промокод \(`null` если промокод не применен, или если введенный промокод невозможно применить\)
* **`discount`** - суммарная скидка на заказ
* **`items`** - новый состав корзины \(со скидками и подарками\)
  * **`id`** - идентификатор товарного предложения в системе клиента
  * **`price`** - изначальная цена до скидок
  * **`discount`** - примененная скидка **на всю позицию**
  * **`quantity`** - количество
  * **`subtotal`** - итого \(`subtotal` = \(`price` \* `quantity`\) - `discount`\)
  * **`gift`** - \(опционально\) количество товаров данной позиции в подарок
  * **`appliedDiscounts`** - \(опционально\) JSON список идентификаторов примененных акций \(например `["a1123767", "a98723677"]`\)
  * **`bonuses`** - \(опционально\) информация по бонусам для данной позиции:
    * **`canSpend`** - максимальное число баллов для списания на данную позицию
* **`dynamicDiscounts`** - список маркетинговых акций примененных в корзине
  * **`id`** - идентификатор
  * **`name`** - название
  * **`gifts`** - список товаров, предлагаемых в виде подарка \(не на выбор\). Если покупатель примет подарок, то эти товары будут добавлены в корзину.
  * **`giftOptions`** - список товаров, предлагаемых в виде подарка на выбор. Если покупатель примет подарок, то один товар из этой группы будет добавлен в корзину.
* **`bonuses`** - информация по бонусам для данного заказа
  * **`canSpend`** - можно списать бонусов на весь заказ суммарно
  * **`willEarn`** - будет накоплено баллов после заказа

### Пример ответа

```javascript
{
    "totalPrice": 95000,
    "appliedPromocode": null,
    "discount": 1000,
    "items": [
        {
            "name": "Apple iPad (2018) 64Gb Wi-Fi, серебристый",
            "id": "12345",
            "price": 29990,
            "discount": 0,
            "quantity": 1,
            "subtotal": 29990,
            "bonuses": { "canSpend": 1990 }
        },
        {
            "name": "Apple Pencil 1-го поколения",
            "id": "22345",
            "price": 8890,
            "discount": 1000,
            "quantity": 1,
            "subtotal": 7890,
            "appliedDiscounts": ["dd76656711"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 черный",
            "id": "32345",
            "price": 2999,
            "discount": 2999,
            "quantity": 1,
            "appliedDiscounts": ["dd1218888"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 коричневый",
            "id": "42345",
            "price": 1000,
            "discount": 2000,
            "quantity": 3,
            "gift": 2,
            "appliedDiscounts": ["dd771086"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 черный",
            "id": "87787",
            "price": 1000,
            "discount": 1000,
            "quantity": 1,
            "appliedDiscounts": ["dd771099"],
            "gift": 1,
            "bonuses": { "canSpend": 0 }
        }
    ],
    "dynamicDiscounts": [
        { "id": "dd76656711", "name": "Скидка 1000 рублей на Apple Pencil при покупе iPad" },
        { "id": "dd1218888", "name": "Чехол Baseus в подарок при покупке iPad и Apple Pencil" },
        { "id": "dd771086", "name": "Чехол в подарок", "gifts": [{ "id": "42345", "quantity": 2 }] },        
        { "id": "dd771099", "name": "Подарок на выбор", "giftOptions": [ { "id": "87787", "quantity": 1 }, { "id": "1234567801", "quantity": 3} ] }
    ],
    "bonuses": {
        "canSpend": 1990,
        "willEarn": 1600
    }
}
```

