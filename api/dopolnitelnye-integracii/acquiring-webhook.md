# Эквайринг через webhook

{% hint style="danger" %}
Дополнительные интеграции вводятся в эксплуатацию после завершения основных интеграций:

* [Оформление заказа](../oformlenie-zakaza.-dostavki-oplaty/order.md)
* [Доставки](../oformlenie-zakaza.-dostavki-oplaty/deliveries.md)
* [Оплаты](../oformlenie-zakaza.-dostavki-oplaty/payments.md)

Для подключения дополнительных интеграций обратитесь к вашему менеджеру в IMSHOP.IO
{% endhint %}

Подключение эквайринга из webhook позволяет настроить оплату картой или Apple Pay в приложении без дополнительных интеграций и доработок на стороне IMSHOP.IO

## Общее описание процеса

### Оплата картой

* Пользователь оформляет заказ. Заказ выгружается в систему клиента через webhook. Заказу присваивается номер.
* Пользователь видит экран подтверждения заказа. Пользователь нажимает кнопку "перейти к оплате"
* IMSHOP.IO делает запрос в webhook управления оплатами на создание платежа. В ответ должны быть переданы:
  * Идентификатор платежа из платежного шлюза
  * URL для перенаправления пользователя для ввода данных карты (это должен быть URL, выданный платежной системой, а не URL ведущий на сайт)
  * Регулярное выражение для определения success / failure сценариев по URL, на который платежная система перенаправит пользователя
* В мобильном приложении отображается экран оплаты с вводом карты для оплаты
* Пользователь вводит данные карты / код 3dsec из смс
* Приложение определяет при помощи регулярного выражения, что сценарий оплаты отработал до конца
* IMSHOP.IO делает запрос в webhook управления оплатами на проверку статуса оплаты
* Система клиента связывается с платежной системой и проверяет оплату. Далее, если оплата не прошла, webhook должен вернуть ошибку. Если платеж успешно принят, система клиента инициирует списывание средств, и возвращает через webhook, что платеж прошел успешно.
* IMSHOP.IO помечает заказ как оплаченный

### Apple Pay

* Пользователь находится на корзине / на карточке товара и видит кнопку "купить с Apple Pay"
* Пользователь нажимает кнопку Apple Pay, проверяет контакт, адрес доставки и стоимость, и подтверждает оплату
* Заказ оформляется и выгружается в систему клиента через webhook. Заказу присваивается номер
* IMSHOP.IO делает запрос в webhook управления оплатами на создание платежа через Apple Pay. В теле запроса передается криптограмма Apple Pay
* Система клиента передает криптограмму в процессор платежей и иницирует списание средств. Если оплата прошла, то webhook передает идентификатор платежа и статус. Если заказ не прошел, webhook должен вернуть ошибку
* IMSHOP.IO помечает заказ как оплаченный

### Google Pay (в разработке)

* Пользователь находится на корзине / на карточке товара и видит кнопку "купить с Google Pay"
* Пользователь нажимает кнопку Google Pay, адрес доставки и стоимость, и подтверждает оплату
* Заказ оформляется и выгружается в систему клиента через webhook. Заказу присваивается номер
* IMSHOP.IO делает запрос в webhook управления оплатами на создание платежа через Google Pay. В теле запроса передается криптограмма Google Pay
* Система клиента передает криптограмму в процессор платежей и иницирует списание средств. Если оплата прошла, то webhook передает идентификатор платежа и статус. Если заказ не прошел, webhook должен вернуть ошибку
* IMSHOP.IO помечает заказ как оплаченный

## Описание запросов

### Создание платежа по карте

#### **Запрос:**

```javascript
{
    "command": "create",
    "paymentMethodId": "sberbank/card",
    "orderUuid": "cbc85e53-8067-4f13-a708-11d9aea71bf3",
    "orderId": "12345",
    "returnUrl": "imshop://payment/failed"
}
```

* `command` - запрос на создание оплаты (`create`)
* `paymentMethodId` - выбранный покупателем способ оплаты. Берется из ответа [webhook получения способов оплат](https://docs.imshop.io/api/oformlenie-zakaza.-dostavki-oplaty/payments)
* `orderUuid` - внутренний номер заказа в IMSHOP.IO
* `orderId` - внешний номер заказа в системе клиента
* `returnUrl` - ссылка на возврат в приложение в случае отмены оплаты

#### **Ответ:**

```javascript
{
    "success": true,
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81",
    "paymentUrl": "https://kassa.yandex.ru/payment/xxxxxxxxxxxxxxx",
    "successRegex": "payment/(.+)/success",
    "failureRegex": "payment/(.+)/failed"
}
```

* `success` - флаг успеха `true` / `false`
* `paymentId` - идентификатор платежа
* `paymentUrl` - URL для оплаты
* `successRegex` - регулярное выражение для проверки редиректа на успех
* `failureRegex` - регулярное выражение для проверки редиректа при непринятой карте

### Создание платежа ApplePay

#### **Запрос:**

```javascript
{
    "command": "applepay",
    "paymentMethodId": "sberbank/applepay",
    "orderUuid": "cbc85e53-8067-4f13-a708-11d9aea71bf3",
    "orderId": "12345",
    "applePayData": "xxxxxxxxxxxxxxxxxxxxxxxxx"
}
```

* `command` - запрос на создание оплаты Google Pay (`androidpay`)
* `paymentMethodId` - выбранный покупателем способ оплаты. Берется из ответа [webhook получения способов оплат](https://developer.imshop.io/developers/deliveries-and-payments/payments)
* `orderUuid` - внутренний номер заказа в IMSHOP.IO
* `orderId` - внешний номер заказа в системе клиента
* `androidPayData` - криптограмма Android Pay, в формате base64

#### **Ответ:**

```javascript
{
    "success": true,
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81",
    "paymentCaptured": true
}
```

* `success` - флаг успеха `true` / `false`
* `paymentId` - идентификатор платежа
* `paymentCaptured` - деньги успешно списаны
* `error` (опционально) - текст ошибки если `success` = `false`

### Создание платежа Google Pay (в разработке)

**Запрос:**

```javascript
{
    "command": "androidpay",
    "paymentMethodId": "sberbank/androidpay",
    "orderUuid": "cbc85e53-8067-4f13-a708-11d9aea71bf3",
    "orderId": "12345",
    "androidPayData": "xxxxxxxxxxxxxxxxxxxxxxxxx"
}
```

* `command` - запрос на создание оплаты Apple Pay (`applepay`)
* `paymentMethodId` - выбранный покупателем способ оплаты. Берется из ответа [webhook получения способов оплат](https://developer.imshop.io/developers/deliveries-and-payments/payments)
* `orderUuid` - внутренний номер заказа в IMSHOP.IO
* `orderId` - внешний номер заказа в системе клиента
* `applePayData` - криптограмма Apple Pay, в формате base64

**Ответ:**

```javascript
{
    "success": true,
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81",
    "paymentCaptured": true
}
```

* `success` - флаг успеха `true` / `false`
* `paymentId` - идентификатор платежа
* `paymentCaptured` - деньги успешно списаны
* `error` (опционально) - текст ошибки если `success` = `false`

### Верификация платежа и списание средств

#### **Запрос:**

```javascript
{
    "command": "capture",
    "paymentMethodId": "sberbank/card",
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81"
}
```

* `command` - запрос на проведение платежа и проверку факта списания (`capture`)
* `paymentMethodId` - выбранный покупателем способ оплаты. Берется из ответа [webhook получения способов оплат](../oformlenie-zakaza.-dostavki-oplaty/payments.md)
* `paymentId` - Идентификатор платежа

**Ответ:**

```javascript
{
    "success": true,
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81",
    "paymentCaptured": true
}
```

* `success` - флаг успеха `true` / `false`
* `paymentId` - идентификатор платежа
* `paymentCaptured` - деньги успешно списаны
* `error` (опционально) - текст ошибки если `success` = `false`

## API для асинхронной смены статуса оплаты - в разработке

{% hint style="info" %}
Для настройки необходимо запросить URL синхронизации у вашего менеджера в IMSHOP.IO
{% endhint %}

Очень часто списание средств может происходить с задержкой, поэтому не всегда возможно сразу определить факт успешного списания денег.

В этом случае в ответ на запрос `capture` следует передать `"success": true` и дополнительное поле `"pending": true`. В этом случае IMSHOP.IO будет рассматривать платеж как принятый в обработку.

Когда платежный провайдер проинформирует вас о смене статуса оплаты, необходимо отправить POST запрос на предоставленный URL со следующим телом:

```javascript
{
    "orderId": "12345",
    "paymentId": "7d0567f9-bf37-4e84-9580-86b68b8a0e81",
    "success": true,
    "paymentCaptured": true
}
```

* `orderId` - номер заказа из системы клиента
* `paymentId` - идентификатор платежа
* `success` - всегда `true`
* `paymentCaptured` - `true` eсли платеж успешно проведен, `false` если платеж не прошел
* `retry` (опционально) - если `paymentCaptured` = `false` и `retry` = `true` то пользователю будет дана возможность повторить оплату. При этом флоу оплаты начнется с самого начала (будет отправлен запрос с `command` = `create`)
