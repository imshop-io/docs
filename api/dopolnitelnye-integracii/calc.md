# Расчет корзины, скидок, баллов

{% hint style="danger" %}
Дополнительные интеграции вводятся в эксплуатацию после завершения основных интеграций:

* [Оформление заказа](../oformlenie-zakaza.-dostavki-oplaty/order.md)
* [Доставки](../oformlenie-zakaza.-dostavki-oplaty/deliveries.md)
* [Оплаты](../oformlenie-zakaza.-dostavki-oplaty/payments.md)

Для подключения дополнительных интеграций обратитесь к вашему менеджеру в IMSHOP.IO
{% endhint %}

IMSHOP.IO позволяет при помощи webhook подключить уже существующую на вашей стороне систему пересчета корзины с учетом акций, предложений, бонусных баллов итд.

{% hint style="info" %}
Пересчет корзины через webhook означает, что для каждого изменения состава корзины IMSHOP.IO будет отправлять данные о заказе в систему клиента и ожидать в ответ данные об итоговой стоимости заказа и примененных маркетинговых акциях
{% endhint %}

## Формат запроса и примеры

### Пример запроса

```javascript
{
    "city": "Москва",
    "cityKladr": "7700000000000",
    "fiasCode": "77000000000000000000000",
    "deliveryId": null,
    "paymentId": null,
    "preferredPickupId": "a1",
    "items": [
        {
          "name": "Тестовый товар 1",
          "id": "00a03026-412a-54fe-a9df-dcf9325f8618",
          "privateId": "3464",
          "configurationId": "3464",
          "price": 3735,
          "quantity": 1,
          "subtotal": 3735
        },
        {
          "name": "Тестовый товар 2",
          "id": "605e0108-dc95-5dab-95a2-7f459da6aade",
          "privateId": "29117",
          "configurationId": "29117",
          "price": 14540,
          "quantity": 1,
          "subtotal": 14540
        },
        {
          "name": "Тестовый товар 3",
          "id": "3ccd380e-1f40-5056-8a7a-ef6e8a9582b5",
          "privateId": "34607",
          "configurationId": "34607",
          "price": 5723,
          "quantity": 2,
          "subtotal": 11446
        },
        {
          "name": "Тестовый товар 4",
          "id": "523036eb-b776-5795-b24b-0f224f2d8b17",
          "privateId": "6527",
          "configurationId": "6527",
          "price": 29336,
          "quantity": 1,
          "subtotal": 29336
        },
        {
          "name": "Кабель питания Baseus",
          "id": "02ebe9c7-20f0-4cf0-8160-396ef2604daa",
          "privateId": "1234567800",
          "configurationId": "1234567800",
          "price": 2000,
          "quantity": 2,
          "appliedDiscounts": ["dd771099"]
        }
    ],
    "externalUserId": "XXXXXXX",
    "promocode": "12345",
    "promoGroup": [
        {
          "id": "dd771099",
          "gifts": [
            {
              "id": "56789",
              "quantity": 1
            }
          ]
        }
    ],
    "installId": "ed6b1eec-082f-4880-9100-bcd8e2016cd1",
    "loyaltyCard": "12345",
    "preferredPickupId": null
}
```

### Описание формата запроса

* **`city`** - Стандартизированное название города из системы ФИАС
* **`cityKladr`** - КЛАДР города
* **`fiasCode`** - ФИАС код
* **`deliveryId`** - идентификатор выбранной службы доставки в IMSHOP.IO \(**`null`** если доставка еще не выбрана\)
* **`paymentId`** - идентификатор выбранной службы оплаты в IMSHOP.IO \(**`null`** если оплата еще не выбрана\)
* **`preferredPickupId`** - \(опционально\) выбранный на корзине желаемый пункт выдачи / магазин для получения заказа
* **`items`** - состав корзины
  * **`name`** - наименование
  * **`id`** - идентификатор товара в IMSHOP.IO
  * **`privateId`** - идентификатор товарного предложения в системе клиента
  * **`configurationId`** - идентификатор товарного предложения в IMSHOP.IO
  * **`price`** - цена товара на момент добавления в корзину \(если товар - это подарок на выбор, то тут передается `0`\)
  * **`quantity`** - количество
  * **`subtotal`** - итого по позиции \(`subtotal` = `price` \* `quantity`\)
  * **`appliedDiscounts`** - если предыдущий расчет показал наличие маркетинговой акции, или это - подарок на выбор, то передаем идентификатор акции из прошлого ответа от API
  * **`deliveryGroup`** - \(опционально\) выбранная группа доставки товара, при разбиениии корзины
* **`externalUserId`** - идентификатор покупателя в системе клиента, если известен
* **`promocode`** - промокод, введенный покупателем
* **`promoGroup`** - \(опционально\) группа маркетинговых акций, выбранная покупателем. Поля каждой акции:
  * **`id`** - идентификатор акции
  * **`gifts`** - список товаров, выбранных в качестве подарка. Если акция подразумевает только скидку, это поле не будет заполнено
    * **`id`** - идентификатор товарного предложения
    * **`quantity`** - количество единиц товара
* **`installId`** - идентификатор установки приложения
* **`loyaltyCard`** - номер карты лояльности \(обычно карта лояльности передаваться не будет, так как она часто уже прикреплена к аккаунту покупателя. используется для анонимных заказов, или если клиент не имеет привязки карт лояльности к профилям пользователей\)
* **`preferredPickupId`** - id любимого пункта самовывоза \(если есть\)

{% hint style="info" %}
В полях запроса могут быть переданы идентификаторы даты/времени интервала доставки \(**в разработке**\)
{% endhint %}

* **`deliveryDateIntervalId`** - \(опционально\) идентификатор, привязанный к датам, полученный в поле **`dateIntervals[<index>].id`** вебхука доставок
* **`deliveryTimeIntervalId`** - \(опционально\) идентификатор, привязанный ко времени, полученный в поле **`dateIntervals[<index>].timeIntervals[<index>].id`** вебхука доставок

```javascript
{
    ...
      "deliveryDateIntervalId": "21-06-10",
      "deliveryTimeIntervalId": "10-15",
    ...
}
```

## Формат ответа и примеры

### Описание формата

Бекенд клиента должен ответить на вебхук с `application/json` в следующем формате:

* **`totalPrice`** - итоговая цена корзины с учетом всех скидок и МА
* **`appliedPromocode`** - примененный промокод \(`null` если промокод не применен, или если введенный промокод невозможно применить\)
* **`discount`** - суммарная скидка на заказ
* **`showDoNotCallMeCheckbox`** - показывать чекбокс **Не перезванивать**
* **`items`** - новый состав корзины \(со скидками и подарками\)
  * **`id`** - идентификатор товарного предложения в системе клиента
  * **`price`** - изначальная цена до скидок
  * **`discount`** - примененная скидка **на всю позицию**
  * **`quantity`** - количество
  * **`subtotal`** - итого \(`subtotal` = \(`price` \* `quantity`\) - `discount`\)
  * **`gift`** - \(опционально\) количество товаров данной позиции в подарок
  * **`appliedDiscounts`** - \(опционально\) JSON список идентификаторов примененных акций \(например `["a1123767", "a98723677"]`\)
  * **`bonuses`** - \(опционально\) информация по бонусам для данной позиции:
    * **`canSpend`** - максимальное число баллов для списания на данную позицию
    * **`willEarn`** - максимальное число баллов для накопления на данную позицию
  * **`deliveryGroups`** - \(опционально; значения: **`default`**, **`express`**, **`large`**\) группы доступных доставок, массив; значение по умолчанию: **`["default", "express", "large"]`**
  * **`error`** - \(опционально\). Текст ошибки, если есть. Если есть хотя бы одна позиция с ошибкой, оформить такой заказ будет невозможно. Ошибка выводится в корзине напротив товара. Пример: "Товар недоступен для заказа"
  * **`notice`** - \(опционально, в разработке\). Текст сообщения, выводится в корзине около товара, например,  если есть акция 1+1 = 3 на данный товар, чтобы уведомить покупателя.
* **`bonuses`** - информация по бонусам для данного заказа
  * **`canSpend`** - можно списать бонусов на весь заказ суммарно
  * **`willEarn`** - будет накоплено баллов после заказа

### Пример ответа

```javascript
{
    "totalPrice": 95000,
    "appliedPromocode": null,
    "discount": 1000,
    "items": [
        {
            "name": "Apple iPad (2018) 64Gb Wi-Fi, серебристый",
            "id": "12345",
            "price": 29990,
            "discount": 0,
            "quantity": 1,
            "subtotal": 29990,
            "bonuses": { "canSpend": 1990 }
        },
        {
            "name": "Apple Pencil 1-го поколения",
            "id": "22345",
            "price": 8890,
            "discount": 1000,
            "quantity": 1,
            "subtotal": 7890,
            "appliedDiscounts": ["dd76656711"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 черный",
            "id": "32345",
            "price": 2999,
            "discount": 2999,
            "quantity": 1,
            "appliedDiscounts": ["dd1218888"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 коричневый",
            "id": "42345",
            "price": 1000,
            "discount": 2000,
            "quantity": 3,
            "gift": 2,
            "appliedDiscounts": ["dd771086"],
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Чехол Baseus для iPad 2018 черный",
            "id": "87787",
            "price": 1000,
            "discount": 1000,
            "quantity": 1,
            "appliedDiscounts": ["dd771099"],
            "gift": 1,
            "bonuses": { "canSpend": 0 }
        },
        {
            "name": "Apple Mac Pro 2020",
            "id": "80008",
            "price": 5000000,
            "discount": 1000,
            "quantity": 1,
            "bonuses": { "canSpend": 0 },
            "deliveryGroups": ["express"],
            "error": "Позиция отсутствует на складе"
        }
    ],
    "bonuses": {
        "canSpend": 1990,
        "willEarn": 1600
    }
}
```

### Маркетинговые акции

Добавляются в стандартный ответ расчета корзины:

* **`promoGroups`** - список групп маркетинговых акций, доступных в корзине на выбор \(в каждой группе их может быть несколько\)
  * **`id`** - идентификатор акции
  * **`name`** - название акции
  * **`sumsWithBonuses`** - суммируется ли акция с бонусами. Если покупатель выберет акцию с этим флагом в значении`false`, ему будет доступна опция `Получить или потратить бонусы` для отказа от участия в акциях.
  * **`gifts`** - список товаров, предлагаемых в виде подарка \(не на выбор\). Если покупатель примет подарок, то эти товары будут добавлены в корзину.
    * **`id`** - идентификатор товарного предложения
    * **`quantity`** - количество единиц товара
  * **`giftOptions`** - список товаров, предлагаемых в виде подарка на выбор. Если покупатель примет подарок, то товар из этого списка будет добавлен в корзину.
    * **`id`** - идентификатор товарного предложения
    * **`quantity`** - количество единиц товара
  * **`giftOptionsLimit`**- количество вариантов подарков, доступных пользователю на выбор \(используется, если список`giftOptions` заполнен, `1` по умолчанию\)
  * **`discount`**- сумма скидки на всю корзину, применяемая при выборе акции \(заменяет значение `discount`основного тела ответа и не суммируется с ним\)

```javascript
{
    ...
    "promoGroups": [
      [
        {
          "id": "dd76656711",
          "name": "Скидка 1000 рублей на Apple Pencil при покупе iPad",
          "discount": 1000,
          "sumsWithBonuses": false
        }
      ],
      [
        {
          "id": "dd1218888",
          "name": "Чехол Baseus в подарок при покупке iPad и Apple Pencil",
          "sumsWithBonuses": false,
          "gifts": [
            {
              "id": "98765",
              "quantity": 1
            }
          ]
        }
      ],
      [
        {
          "id": "dd771099",
          "name": "Подарок на выбор при заказе от 5000",
          "sumsWithBonuses": true,
          "giftOptions": [
            {
              "id": "12345",
              "quantity": 1
            },
            {
              "id": "56789",
              "quantity": 1
            }
          ],
          "giftOptionsLimit": 1
        }
      ]
    ]
    ...
}
```

