# Авторизация/регистрация по номеру телефона + SMS \(предпочтительный способ авторизации\)

![](../../.gitbook/assets/getuserdatainfr.png)

{% hint style="info" %}
**OTP** = one-time password, одноразовый пароль
{% endhint %}

«Золотой» сценарий:

1. Пользователь вводит номер телефона \(или адрес email\)
2. Мобильное приложение отправляет запрос **OTP** в сервер IMSHOP.IO
3. Сервер IMSHOP.IO запрашивает отправку **OTP** в вашей инфраструктуре
4. Вы отправляете SMS \(или электронное письмо\), содержащее **OTP**
5. Пользователь вводит **OTP**
6. Мобильное приложение отправляет **OTP** в сервер IMSHOP.IO
7. Сервер IMSHOP.IO запрашивает подтверждение **OTP** в вашей инфраструктуре
8. Ваша инфраструктура подтверждает введенный **OTP**, авторизует или регистрирует нового пользователя, а также возвращает данные пользователя 

### Запрос OTP

`APP SERVER → INFRASTRUCTURE`

{% hint style="info" %}
От вас потребуется URL, на который наш сервер будет слать **POST**-запрос.
{% endhint %}

В вашу систему будут приходить вот такие данные:

```javascript
{
    "userIdentifier": "71234567890"
}
```

* `userIdentifier` — идентификатор пользователя \(обязательное поле\)

Идентификатор пользователя — это номер телефона, адрес email, или любой другой идентификатор \(например, логин\), как договоримся. В случае с номером телефона мы присылаем только цифры, через семёрку.

**Ответ:**

```javascript
{
    "otp": {
        "timeout": 30,
        "attemptsLeft": 3,
        "message": "На номер +7 (965) ***-**-00 отправлено сообщение с кодом",
        "codeLength": 4
    }
}
```

* `timeout` — сколько секунд осталось до возможности повторно запросить **OTP** \(необязательное поле; по умолчанию 120 секунд\)
* `attemptsLeft` — сколько ещё одноразовых паролей можно запросить \(необязательное поле; по умолчанию количество неограниченное\)
* `message` — сообщение для пользователя \(обязательное поле\)
* `codeLength` — длина **OTP** \(необязательное поле; по умолчанию 4\)

{% hint style="info" %}
Номера телефонов стоит частично маскировать, чтобы у вас не увели базу данных пользователей, но владелец номера всё равно мог понять, куда именно ему придёт SMS.
{% endhint %}

**Ошибка: отправка OTP невозможна**

Возможно, SMS-шлюз не отзывается, либо вы по какой-то причине не хотите авторизовывать пользователя с таким идентификатором.

```javascript
{
    "error": {
        "message": "Превышено количество попыток входа"
    }
}
```

* `message` — сообщение для пользователя, описывающее проблему \(обязательное поле\)

{% hint style="info" %}
Запрос нового **OTP** осуществляется посредством повторной отправки этого же запроса.
{% endhint %}

### Подтверждение OTP

`APP SERVER → INFRASTRUCTURE`

{% hint style="info" %}
От вас потребуется URL, на который наш сервер будет слать **POST**-запрос.
{% endhint %}

В вашу систему будут приходить вот такие данные:

```javascript
{
    "userIdentifier": "71234567890",
    "otp": "555666"    
}
```

* `userIdentifier` — идентификатор пользователя \(обязательное поле\)
* `otp` — пароль, введенный пользователем \(обязательное поле\)

Чтобы **OTP** в SMS корректно воспринимался операционными системами iOS и Android, он должен содержать только цифры. Шесть штук. Такой формат позволит автоматически вставлять код из SMS одним нажатием. Если вы хотите другой формат — _сообщите нам заранее,_ нам необходимо будет заменить валидацию_._

**Ответ:**

```javascript
{
    "user": {
        "id": "71234567890",
        "name": "Иванов Иван",
        "phone": "71234567890",
        "email": "ivanov@mail.com",
        "bonuses": 10000,
        "segments": ["registered", "loyal"],
        "age": 35,
        "gender": "male",
        "cardNumber": "456123789"
    }
}
```

* `id` — идентификатор пользователя \(обязательное поле\)
* `name` — имя пользователя, достаточное для оформления заказа \(необязательное поле\)
* `phone` — номер телефона пользователя \(необязательное поле\)
* `email` — адрес электропочты пользователя \(необязательное поле\)
* `bonuses` — количество бонусов на счету пользователя \(необязательное поле\)
* `segments` — сегменты, к которым относится пользователя \(необязательное поле\)
* `cardNumber` — номер карты лояльности \(необязательное поле\)
* … и любые другие поля.

{% hint style="info" %}
Идентификатор **`id`** пользователя необходим для других авторизованных запросов. Например, [получения истории](order-history.md).
{% endhint %}

В случае, если пользователь новый, и информации по нему никакой нет — допустимо присылать пустые поля \(все, кроме `id`\), или не присылать их вовсе. Любой ответ, не содержащий ключа **`error`**, будет расцениваться как успешный.

**Ошибка: подтверждение OTP не произошло**

Возможно, пользователь ввёл неправильные цифры. Возможно, на вашей стороне произошла какая-то другая ошибка. Возможно, вы передумали авторизовывать этого пользователя.

```javascript
{
    "error": {
        "message": "Неправильный код"
    }
}
```

